rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user document from users collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user has a specific role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Check if user has any of the specified roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }
    
    // Check if user is a super admin
    function isSuperAdmin() {
      return hasRole('super_admin');
    }
    
    // Check if user is a recruiter or higher
    function isRecruiterOrAdmin() {
      return hasAnyRole(['super_admin', 'recruiter']);
    }
    
    // Check if user is a branch manager
    function isBranchManager() {
      return hasRole('branch_manager');
    }
    
    // Check if user is a regional manager
    function isRegionalManager() {
      return hasRole('regional_manager');
    }
    
    // Check if user is a viewer
    function isViewer() {
      return hasRole('viewer');
    }
    
    // Check if user is active
    function isActiveUser() {
      return isAuthenticated() && getUserData().active == true;
    }
    
    // Check if user can access a specific branch
    function canAccessBranch(branchId) {
      let userData = getUserData();
      return isSuperAdmin() 
        || isRecruiterOrAdmin()
        || (isBranchManager() && branchId in userData.branchIds)
        || (isRegionalManager() && branchId in userData.regionBranchIds);
    }
    
    // Check if user can access a specific entity
    function canAccessEntity(entity) {
      let userData = getUserData();
      return isSuperAdmin() 
        || !('entities' in userData) 
        || userData.entities == null
        || entity in userData.entities;
    }
    
    // Validate timestamp is server timestamp
    function isValidTimestamp(field) {
      return request.resource.data[field] == request.time;
    }
    
    // Check if field is not being modified
    function isUnchanged(field) {
      return !(field in request.resource.data) 
        || request.resource.data[field] == resource.data[field];
    }
    
    // ============================================================
    // USERS COLLECTION
    match /users/{userId} {
      // Super admins can read all users (for user management)
      // Users can read their own document (needed for login)
      allow read: if isSuperAdmin() || (request.auth != null && request.auth.uid == userId);
      
      // Only super admins can create users
      allow create: if isSuperAdmin();
      
      // Super admins can update any user
      // Users can update their own preferences only
      allow update: if isSuperAdmin() 
        || (request.auth.uid == userId && onlyUpdatingPreferences());
      
      // Only super admins can delete users
      allow delete: if isSuperAdmin();
      
      // Helper: check if only updating allowed self-update fields
      function onlyUpdatingPreferences() {
        let allowedFields = ['emailNotifications', 'pushNotifications', 'avatarUrl', 'displayName', 'updatedAt', 'lastLoginAt'];
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();
        return changedFields.hasOnly(allowedFields);
      }
    }
    
    // ============================================================
    // CANDIDATES COLLECTION
    // ============================================================
    match /candidates/{candidateId} {
      // Read access:
      // - Super admins and recruiters: all candidates
      // - Regional managers: candidates in their regions
      // - Branch managers: limited - only candidates scheduled at their branch
      // - Viewers: all candidates (read-only)
      allow read: if isActiveUser() && (
        isRecruiterOrAdmin()
        || isViewer()
        || isRegionalManager()
        // Branch managers can only see via interview/trial queries
      );
      
      // Create: recruiters/admins OR public job applications
      allow create: if (isRecruiterOrAdmin() && isValidCandidateData())
        || isValidPublicApplication();
      
      // Update: only recruiters and admins
      allow update: if isRecruiterOrAdmin();
      
      // Delete: only recruiters and admins (soft delete preferred)
      allow delete: if isRecruiterOrAdmin();
      
      // Validate candidate data (authenticated)
      function isValidCandidateData() {
        let data = request.resource.data;
        let hasFirstName = data.firstName is string && data.firstName.size() > 0;
        let hasLastName = data.lastName is string && data.lastName.size() > 0;
        let hasEmail = data.email is string;
        let hasPhone = data.phone is string;
        let hasStatus = data.status in ['new', 'screening', 'interview_scheduled', 'interview_complete', 
                            'trial_scheduled', 'trial_complete', 'approved', 'rejected', 'withdrawn'];
        
        return hasFirstName && hasLastName && hasEmail && hasPhone && hasStatus;
      }
      
      // Validate public job application (unauthenticated)
      function isValidPublicApplication() {
        let data = request.resource.data;
        return data.firstName is string && data.firstName.size() > 0
          && data.lastName is string && data.lastName.size() > 0
          && data.email is string && data.email.size() > 0
          && data.phone is string && data.phone.size() > 0
          && data.status == 'new'
          && data.source == 'website';
      }
      
      // Activity log subcollection
      match /activityLog/{logId} {
        allow read: if isRecruiterOrAdmin() || isViewer();
        allow create: if isRecruiterOrAdmin();
        allow update, delete: if false; // Activity logs are immutable
      }
    }
    
    // ============================================================
    // JOBS COLLECTION
    // ============================================================
    match /jobs/{jobId} {
      // Public can read active jobs (for job application page)
      // Authenticated users can read all jobs
      allow read: if resource.data.status == 'active' || isActiveUser();
      
      // Only recruiters and admins can create/update jobs
      allow create: if isRecruiterOrAdmin() 
        && isValidJobData()
        && isValidTimestamp('createdAt');
      
      allow update: if isRecruiterOrAdmin() 
        && isValidJobData()
        && isUnchanged('createdAt')
        && isUnchanged('createdBy');
      
      // Only super admins can delete jobs
      allow delete: if isSuperAdmin();
      
      function isValidJobData() {
        let data = request.resource.data;
        return data.title is string && data.title.size() > 0
          && data.branchId is string
          && data.entity in ['allied', 'sharief', 'core']
          && data.status in ['draft', 'active', 'closed'];
      }
    }
    
    // ============================================================
    // JOB TYPES COLLECTION
    // ============================================================
    match /jobTypes/{jobTypeId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ============================================================
    // INTERVIEWS COLLECTION (R6.6-R6.11)
    // ============================================================
    match /interviews/{interviewId} {
      // Read access:
      // - Public: can read scheduled/confirmed interviews (for booking conflict checks)
      // - Authenticated: based on role and branch
      allow read: if resource.data.status in ['scheduled', 'confirmed']
        || (isActiveUser() && (
          isRecruiterOrAdmin()
          || isViewer()
          || (isBranchManager() && canAccessBranch(resource.data.branchId))
          || (isRegionalManager() && canAccessBranch(resource.data.branchId))
        ));
      
      // Create interviews:
      // - Recruiters can create any interview
      // - Public can create self-service bookings (from booking page)
      allow create: if (isRecruiterOrAdmin() && isValidInterviewData() && isValidTimestamp('createdAt'))
        || isValidSelfServiceBooking();
      
      // Recruiters can update all fields
      // Branch managers can only update feedback fields
      allow update: if (isRecruiterOrAdmin() && isValidInterviewData())
        || (isBranchManager() 
            && canAccessBranch(resource.data.branchId)
            && onlyUpdatingFeedbackFields());
      
      allow delete: if isRecruiterOrAdmin();
      
      function isValidInterviewData() {
        let data = request.resource.data;
        return data.candidateId is string
          && data.candidateName is string
          && data.type in ['interview', 'trial']
          && data.status in ['scheduled', 'completed', 'cancelled', 'no_show']
          && data.duration is number
          && data.duration > 0
          && data.duration <= 480  // Max 8 hours
          && data.scheduledDate is timestamp
          && (!('bookedVia' in data) || data.bookedVia in ['manual', 'self_service']);
      }
      
      // Validate self-service bookings from public booking page
      function isValidSelfServiceBooking() {
        let data = request.resource.data;
        return data.candidateId is string
          && data.candidateName is string
          && data.type in ['interview', 'trial']
          && data.status == 'scheduled'
          && data.duration is number
          && data.duration > 0
          && data.duration <= 480
          && data.scheduledDate is timestamp
          && data.bookedVia == 'self_service';
      }
      
      function onlyUpdatingFeedbackFields() {
        let allowedFields = ['feedback', 'rating', 'notes', 'internalNotes', 'status', 'updatedAt'];
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();
        return changedFields.hasOnly(allowedFields);
      }
    }
    
    // ============================================================
    // BOOKING LINKS COLLECTION (R6.3-R6.11)
    // ============================================================
    match /bookingLinks/{linkId} {
      // Public can read booking links (needed for booking page token validation)
      // Recruiters can read all booking links
      allow read: if true;
      
      // Recruiters can create booking links
      allow create: if isRecruiterOrAdmin() 
        && isValidBookingLinkData();
      
      // Recruiters can update status (revoke, mark used)
      // Public can update useCount when booking (via self-service)
      allow update: if isRecruiterOrAdmin() 
        || isValidBookingLinkUpdate();
      
      allow delete: if isSuperAdmin();
      
      // Validation for creating booking links (relaxed for bulk invites)
      function isValidBookingLinkData() {
        let data = request.resource.data;
        return data.candidateId is string
          && data.candidateName is string
          && data.tokenHash is string
          && data.type in ['interview', 'trial']
          && data.status in ['active', 'used', 'expired', 'revoked']
          && data.maxUses is number
          && data.maxUses >= 1;
        // Note: duration and expiresAt are optional for flexibility
      }
      
      // Allow public to mark booking link as used
      function isValidBookingLinkUpdate() {
        let allowedFields = ['useCount', 'status', 'updatedAt', 'usedAt'];
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();
        return changedFields.hasOnly(allowedFields);
      }
    }
    
    // ============================================================
    // SCHEDULING AVAILABILITY COLLECTION (R6.1-R6.2)
    // ============================================================
    match /schedulingAvailability/{docId} {
      // All active users can read availability (needed for self-service booking)
      allow read: if isActiveUser() || true;  // Public for booking page
      
      // Only recruiters and admins can modify availability
      allow create, update: if isRecruiterOrAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // WHATSAPP TEMPLATES COLLECTION
    // ============================================================
    match /whatsappTemplates/{templateId} {
      allow read: if isRecruiterOrAdmin();
      allow create, update: if isRecruiterOrAdmin();
      allow delete: if isSuperAdmin();
    }

    // ============================================================
    // EMAIL TEMPLATES COLLECTION
    // ============================================================
    match /emailTemplates/{templateId} {
      allow read: if isRecruiterOrAdmin();
      allow create, update: if isRecruiterOrAdmin();
      allow delete: if isSuperAdmin();
    }

    // ============================================================
    // EMAIL TRACKING COLLECTION
    // ============================================================
    match /emailTracking/{trackingId} {
      allow read: if isRecruiterOrAdmin();
      allow create: if isRecruiterOrAdmin();
      allow update: if true; // Allow tracking pixel/click updates
      allow delete: if isSuperAdmin();
    }

    // ============================================================
    // TRIAL FEEDBACK COLLECTION
    // ============================================================
    match /trialFeedback/{feedbackId} {
      // Recruiters can read all feedback
      // Branch managers can read feedback for their branches
      allow read: if isActiveUser() && (
        isRecruiterOrAdmin()
        || isViewer()
        || (isBranchManager() && canAccessBranch(resource.data.branchId))
        || (isRegionalManager() && canAccessBranch(resource.data.branchId))
      );
      
      // Branch managers can create feedback for their branch
      // Recruiters can create feedback
      allow create: if isActiveUser() && (
        isRecruiterOrAdmin()
        || (isBranchManager() && canAccessBranch(request.resource.data.branchId))
      ) && isValidFeedbackData();
      
      // Only the submitter or admins can update feedback
      allow update: if isActiveUser() && (
        isRecruiterOrAdmin()
        || (resource.data.submittedBy == request.auth.uid && resource.data.status == 'pending')
      );
      
      allow delete: if isSuperAdmin();
      
      function isValidFeedbackData() {
        let data = request.resource.data;
        return data.candidateId is string
          && data.branchId is string
          && data.recommendation in ['hire', 'maybe', 'do_not_hire'];
      }
    }
    
    // ============================================================
    // INTERVIEW FEEDBACK COLLECTION
    // ============================================================
    match /interviewFeedback/{feedbackId} {
      allow read: if isActiveUser() && (
        isRecruiterOrAdmin()
        || isViewer()
        || (isBranchManager() && canAccessBranch(resource.data.branchId))
      );
      
      allow create: if isRecruiterOrAdmin() || (
        isBranchManager() && canAccessBranch(request.resource.data.branchId)
      );
      
      allow update: if isRecruiterOrAdmin() 
        || (resource.data.submittedBy == request.auth.uid);
      
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // BRANCHES COLLECTION
    // ============================================================
    match /branches/{branchId} {
      // All authenticated users can read branches
      allow read: if isActiveUser();
      
      // Only super admins can create/update/delete branches
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ============================================================
    // REGIONS COLLECTION
    // ============================================================
    match /regions/{regionId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ============================================================
    // QUALIFICATIONS COLLECTION
    // ============================================================
    match /qualifications/{qualificationId} {
      allow read: if isActiveUser();
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ============================================================
    // SETTINGS COLLECTION
    // ============================================================
    match /settings/{settingId} {
      // Settings readable by all authenticated users (basic app data)
      allow read: if isAuthenticated();
      
      // Only admins and recruiters can update settings
      allow create, update: if isRecruiterOrAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // JOB TITLES COLLECTION
    // ============================================================
    match /jobTitles/{jobTitleId} {
      // All authenticated users can read job titles (basic app data)
      allow read: if isAuthenticated();
      
      // Only recruiters and admins can create/update job titles
      allow create, update: if isRecruiterOrAdmin();
      
      // Only super admins can delete job titles
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // ENTITIES COLLECTION
    // ============================================================
    match /entities/{entityId} {
      // All authenticated users can read entities (basic app data)
      allow read: if isAuthenticated();
      
      // Only super admins can create/update/delete entities
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ============================================================
    // JOB CATEGORIES COLLECTION
    // ============================================================
    match /jobCategories/{categoryId} {
      // All authenticated users can read job categories (basic app data)
      allow read: if isAuthenticated();
      
      // Only recruiters and admins can create/update job categories
      allow create, update: if isRecruiterOrAdmin();
      
      // Only super admins can delete job categories
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // LOCATIONS COLLECTION
    // ============================================================
    match /locations/{locationId} {
      // All authenticated users can read locations (basic app data)
      allow read: if isAuthenticated();
      
      // Only recruiters and admins can create/update locations
      allow create, update: if isRecruiterOrAdmin();
      
      // Only super admins can delete locations
      allow delete: if isSuperAdmin();
    }
    
    // ============================================================
    // ACTIVITY LOG COLLECTION (Global)
    // ============================================================
    match /activityLog/{logId} {
      // Read-only for recruiters and admins
      allow read: if isRecruiterOrAdmin() || isViewer();
      
      // Created automatically via Cloud Functions or admin SDK
      allow create: if isRecruiterOrAdmin();
      
      // Activity logs are immutable
      allow update, delete: if false;
    }
    
    // ============================================================
    // NOTIFICATIONS COLLECTION
    // ============================================================
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Created via Cloud Functions
      allow create: if false;
      
      // Users can mark their notifications as read
      allow update: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && onlyUpdatingReadStatus();
      
      allow delete: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      function onlyUpdatingReadStatus() {
        let allowedFields = ['read', 'readAt'];
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();
        return changedFields.hasOnly(allowedFields);
      }
    }
    
    // ============================================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}